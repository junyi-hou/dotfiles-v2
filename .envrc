set -e

_PROJECT_ROOT="$(git rev-parse --show-toplevel)"

export UV_NO_MODIFY_PATH=1
export UV_INSTALL_DIR="$(pwd)/.tools/bin"

if [ ! -f .tools/bin/uv ]; then
    echo "uv not found locally, installing..."
    mkdir -p .tools
    curl -LsSf https://astral.sh/uv/install.sh | sh -s -- 
fi

# Ensure local uv is in PATH
export PATH="$(pwd)/.tools/bin:$PATH"

if [ ! -d .venv ]; then
    uv venv .venv --python "==3.12"
fi

# Activate the virtual environment
source .venv/bin/activate

# rust toolchain
export RUSTUP_HOME="$(pwd)/.rustup"
export CARGO_HOME="$(pwd)/.cargo"
export PATH="$CARGO_HOME/bin:$PATH"

if ! command -v rustup >/dev/null; then
	brew install rustup-init
fi

if [ ! -f .cargo/bin/cargo ]; then
	rustup-init -y --no-modify-path --default-toolchain stable
fi

# PASSAGE RELATED STUFF
export PASSAGE_DIR="$(pwd)/modules/passage/store"
export PASSAGE_IDENTITIES_FILE="$(pwd)/modules/passage/identities"
export PASSAGE_AGE="$(pwd)/.cargo/bin/rage"

# install dependencies
uv sync --all-groups --no-install-project --frozen

if [ ! -f $_PROJECT_ROOT/.cargo/bin/rage ]; then
	cargo install rage --git https://github.com/str4d/rage.git --rev 2094f606d363d88262027bbc9b708c56753d14c2
fi

if [ ! -f $_PROJECT_ROOT/.tools/bin/passage ]; then
	mkdir -p .tools/src
	cd $_PROJECT_ROOT/.tools/src
	git clone https://github.com/FiloSottile/passage.git
	git checkout 4e4c5ae14be91833791d45608f50868175c1490f
	cd passage && make PREFIX=$_PROJECT_ROOT/.tools install
fi
